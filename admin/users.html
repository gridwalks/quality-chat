<!DOCTYPE html><html lang='en'><head>
  <meta name="robots" content="noindex,nofollow"/>
  <style>html.auth-checking body{visibility:hidden}</style><meta charset='UTF-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>Admin · Users</title>
  <link rel='preconnect' href='https://fonts.googleapis.com'>
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
  <script src='https://cdn.tailwindcss.com'></script>
  <script defer src='https://identity.netlify.com/v1/netlify-identity-widget.js'></script>
  <style>
    :root { --brand:#4F46E5; --brand-600:#4F46E5; --brand-700:#4338CA; }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .btn-brand{background:var(--brand-600);color:#fff}
    .btn-brand:hover{background:var(--brand-700)}
  </style>
</head>
<body class='bg-gray-50 text-gray-900'>

  <script>
  (function(){
    try {
      document.documentElement.classList.add('auth-checking');
      var raw = localStorage.getItem('gotrue.user');
      if(!raw){ window.location.replace('/login.html'); return; }
      var u = JSON.parse(raw);
      var roles = (u.app_metadata && u.app_metadata.roles) || [];
      if(!Array.isArray(roles) || roles.indexOf('admin') === -1){
        window.location.replace('/access-denied.html'); return;
      }
      document.documentElement.classList.remove('auth-checking');
    } catch(e){
      window.location.replace('/access-denied.html');
    }
  })();
  </script>

<div class='max-w-5xl mx-auto p-6'>
  <div class='flex items-center justify-between mb-6'><h1 class='text-2xl font-bold'>Users</h1><a href='/admin/' class='px-3 py-2 rounded border bg-white'>← Admin</a></div>
  <div id='auth' class='text-sm text-gray-600 mb-4'>Checking login…</div>
  <div class='bg-white border rounded-xl p-4 shadow-sm'>
    <h2 class='text-lg font-semibold mb-2'>Invite</h2>
    <div class='flex gap-2 mb-2'><input id='inviteEmail' type='email' placeholder='email@company.com' class='flex-1 border rounded p-2'><button id='inviteBtn' class='px-3 py-2 rounded btn-brand text-white' disabled>Send invite</button></div>
    <p id='inviteMsg' class='text-sm'></p>
    <hr class='my-4'><h3 class='font-medium mb-2'>Recovery</h3>
    <div class='flex gap-2 mb-2'><input id='recoverEmail' type='email' placeholder='email@company.com' class='flex-1 border rounded p-2'><button id='recoverBtn' class='px-3 py-2 rounded border bg-white' disabled>Send recovery</button></div>
    <p id='recoverMsg' class='text-sm'></p>
  </div>
</div>
<script>
  const auth=document.getElementById('auth'); const inviteEmail=document.getElementById('inviteEmail'); const inviteBtn=document.getElementById('inviteBtn'); const inviteMsg=document.getElementById('inviteMsg'); const recoverEmail=document.getElementById('recoverEmail'); const recoverBtn=document.getElementById('recoverBtn'); const recoverMsg=document.getElementById('recoverMsg'); const IDENTITY_ADMIN_URL='/.netlify/functions/identity-admin';
  function enable(b){ [inviteBtn,recoverBtn].forEach(x=>x.disabled=!b); }
  function gate(user){ if(!user) return location.replace('/login.html'); const roles=(user.app_metadata&&user.app_metadata.roles)||[]; if(!roles.includes('admin')){ auth.textContent='Admin role required.'; location.replace('/access-denied.html'); return; } auth.textContent='Signed in as '+user.email+' (admin)'; enable(true); }
  document.addEventListener('DOMContentLoaded',()=>{ if(window.netlifyIdentity){ window.netlifyIdentity.on('init',gate); window.netlifyIdentity.init(); } else { location.replace('/login.html'); } });
  inviteBtn.addEventListener('click',async()=>{ inviteMsg.textContent=''; const email=inviteEmail.value.trim(); if(!email){ inviteMsg.textContent='Enter an email.'; inviteMsg.className='text-sm text-red-600'; return;} const res=await fetch(IDENTITY_ADMIN_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'invite',email})}); const j=await res.json(); if(res.ok){ inviteMsg.textContent='Invitation sent.'; inviteMsg.className='text-sm text-green-700'; inviteEmail.value=''; } else { inviteMsg.textContent=j.error||'Failed to send invite.'; inviteMsg.className='text-sm text-red-600'; } });
  recoverBtn.addEventListener('click',async()=>{ recoverMsg.textContent=''; const email=recoverEmail.value.trim(); if(!email){ recoverMsg.textContent='Enter an email.'; recoverMsg.className='text-sm text-red-600'; return;} const res=await fetch(IDENTITY_ADMIN_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'recovery',email})}); const j=await res.json(); if(res.ok){ recoverMsg.textContent='Recovery email sent (if account exists).'; recoverMsg.className='text-sm text-green-700'; recoverEmail.value=''; } else { recoverMsg.textContent=j.error||'Failed to send recovery.'; recoverMsg.className='text-sm text-red-600'; } });
</script>
</body></html>