<!DOCTYPE html><html lang='en'><head>
  <meta name="robots" content="noindex,nofollow"/>
  <style>html.auth-checking body{visibility:hidden}</style><meta charset='UTF-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>Admin · Knowledge Base</title>
  <link rel='preconnect' href='https://fonts.googleapis.com'>
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
  <script src='https://cdn.tailwindcss.com'></script>
  <script defer src='https://identity.netlify.com/v1/netlify-identity-widget.js'></script>
  <style>
    :root { --brand:#4F46E5; --brand-600:#4F46E5; --brand-700:#4338CA; }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .btn-brand{background:var(--brand-600);color:#fff}
    .btn-brand:hover{background:var(--brand-700)}
  </style>
</head>
<body class='bg-gray-50 text-gray-900'>

  <script>
  (function(){
    try {
      document.documentElement.classList.add('auth-checking');
      var raw = localStorage.getItem('gotrue.user');
      if(!raw){ window.location.replace('/login.html'); return; }
      var u = JSON.parse(raw);
      var roles = (u.app_metadata && u.app_metadata.roles) || [];
      if(!Array.isArray(roles) || roles.indexOf('admin') === -1){
        window.location.replace('/access-denied.html'); return;
      }
      document.documentElement.classList.remove('auth-checking');
    } catch(e){
      window.location.replace('/access-denied.html');
    }
  })();
  </script>

<div class='max-w-5xl mx-auto p-6'>
  <div class='flex items-center justify-between mb-6'><h1 class='text-2xl font-bold'>Knowledge Base</h1><a href='/admin/' class='px-3 py-2 rounded border bg-white'>← Admin</a></div>
  <div id='auth' class='text-sm text-gray-600 mb-4'>Checking login…</div>
  <div class='mb-3 flex gap-2'><button id='load' class='px-3 py-2 rounded border bg-white' disabled>Load faqs.json</button><button id='add' class='px-3 py-2 rounded border bg-white' disabled>Add item</button><button id='download' class='px-3 py-2 rounded btn-brand text-white' disabled>Download faqs.json</button></div>
  <div id='list' class='space-y-3'></div>
</div>
<template id='row'>
  <div class='bg-white border rounded-lg p-3 shadow-sm'>
    <div class='grid gap-2 sm:grid-cols-2'>
      <label class='text-sm'>ID<input class='w-full border rounded p-2 mt-1 id' placeholder='unique_id'/></label>
      <label class='text-sm'>Title<input class='w-full border rounded p-2 mt-1 title' placeholder='Short title'/></label>
    </div>
    <label class='block text-sm mt-2'>Text<textarea rows='3' class='w-full border rounded p-2 mt-1 text' placeholder='Content'></textarea></label>
    <label class='block text-sm mt-2'>Tags<input class='w-full border rounded p-2 mt-1 tags' placeholder='comma, separated'/></label>
    <div class='mt-2 flex justify-end gap-2'><button class='px-3 py-1.5 rounded border bg-white dup'>Duplicate</button><button class='px-3 py-1.5 rounded border bg-white del'>Delete</button></div>
  </div>
</template>
<script>
  const auth=document.getElementById('auth'); const loadBtn=document.getElementById('load'); const addBtn=document.getElementById('add'); const dlBtn=document.getElementById('download'); const list=document.getElementById('list'); const tpl=document.getElementById('row');
  function enable(b){ [loadBtn,addBtn,dlBtn].forEach(x=>x.disabled=!b); }
  function gate(user){ if(!user) return location.replace('/login.html'); const roles=(user.app_metadata&&user.app_metadata.roles)||[]; if(!roles.includes('admin')){ auth.textContent='Admin role required.'; location.replace('/access-denied.html'); return; } auth.textContent='Signed in as '+user.email+' (admin)'; enable(true); }
  document.addEventListener('DOMContentLoaded',()=>{ if(window.netlifyIdentity){ window.netlifyIdentity.on('init',gate); window.netlifyIdentity.init(); } else { location.replace('/login.html'); } });
  let data=[]; function render(){ list.innerHTML=''; data.forEach((item,idx)=>{ const node=tpl.content.cloneNode(true); node.querySelector('.id').value=item.id||''; node.querySelector('.title').value=item.title||''; node.querySelector('.text').value=item.text||''; node.querySelector('.tags').value=(item.tags||[]).join(', '); node.querySelector('.id').addEventListener('input',e=>data[idx].id=e.target.value); node.querySelector('.title').addEventListener('input',e=>data[idx].title=e.target.value); node.querySelector('.text').addEventListener('input',e=>data[idx].text=e.target.value); node.querySelector('.tags').addEventListener('input',e=>data[idx].tags=e.target.value.split(',').map(s=>s.trim()).filter(Boolean)); node.querySelector('.dup').addEventListener('click',()=>{ data.splice(idx+1,0,{...data[idx],id:(data[idx].id||'')+'_copy'}); render();}); node.querySelector('.del').addEventListener('click',()=>{ data.splice(idx,1); render();}); list.appendChild(node); }); }
  loadBtn.addEventListener('click',async()=>{ const res=await fetch('/knowledge/faqs.json',{cache:'no-store'}); data=await res.json(); data=data.map(d=>({...d,tags:Array.isArray(d.tags)?d.tags:[]})); render(); });
  addBtn.addEventListener('click',()=>{ data.push({id:'',title:'',text:'',tags:[]}); render(); });
  dlBtn.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='faqs.json'; a.click(); URL.revokeObjectURL(url); });
</script>
</body></html>