<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>AcceleraQA</title>
  <link rel='preconnect' href='https://fonts.googleapis.com'>
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
  <script src='https://cdn.tailwindcss.com'></script>
  <script defer src='https://identity.netlify.com/v1/netlify-identity-widget.js'></script>
  <style>
    :root { --brand:#4F46E5; --brand-600:#4F46E5; --brand-700:#4338CA; }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .btn-brand{background:var(--brand-600);color:#fff}
    .btn-brand:hover{background:var(--brand-700)}
  </style>
</head>
<body class='bg-gray-50 text-gray-900'>
<div class='min-h-screen flex flex-col'>
  <header class='bg-white border-b sticky top-0 z-10'>
    <div class='max-w-4xl mx-auto px-4 py-4 flex items-center justify-between'>
      <div class='flex items-center gap-3'><a href='/index.html'><img src='/assets/logo.svg' class='h-9 w-9 rounded-2xl shadow' alt=''/></a><div><h1 class='text-lg font-semibold'>AcceleraQA</h1><p class='text-xs text-gray-500 -mt-0.5'>Ask anything about QA & Compliance</p></div></div>
      <div class='flex items-center gap-3 text-sm'>
        <a id='adminLink' href='/admin/' class='text-indigo-600 hover:underline hidden'>Admin</a>
        <button id='logoutBtn' class='px-3 py-1.5 rounded border bg-white hidden'>Log out</button>
        <button id='loginBtn' class='px-3 py-1.5 rounded border bg-white'>Sign in</button>
      </div>
    </div>
  </header>
  <main class='flex-1'>
    <div class='max-w-4xl mx-auto px-4 py-6'>
      <div id='whoami' class='text-xs text-gray-500 mb-2'>Browsing as guest</div>
      <section id='chat' class='space-y-4'></section>
    </div>
  </main>
  <footer class='sticky bottom-0 bg-white border-t'><div class='max-w-4xl mx-auto px-4 py-3'>
    <div class='rounded-2xl border bg-white shadow-sm p-2'>
      <textarea id='input' rows='2' placeholder='Ask a quality questionâ€¦ (Shift+Enter = newline)' class='w-full resize-none outline-none p-2 rounded-xl'></textarea>
      <div class='flex items-center justify-between px-1 pb-1'>
        <small class='text-gray-500'>Powered by OpenAI</small>
        <button id='send' class='px-3 py-1.5 rounded-xl btn-brand text-white disabled:opacity-50'>Send</button>
      </div>
    </div></div></footer>
</div>
<script>
  const BACKEND_URL='/.netlify/functions/chat';
  const SEARCH_URL='/.netlify/functions/search';
  const LOG_URL='/.netlify/functions/usage-logger';

  const chatEl=document.getElementById('chat');
  const inputEl=document.getElementById('input');
  const sendBtn=document.getElementById('send');
  const logoutBtn=document.getElementById('logoutBtn');
  const loginBtn=document.getElementById('loginBtn');
  const whoamiEl=document.getElementById('whoami');

  function esc(s){const d=document.createElement('div');d.innerText=String(s);return d.innerHTML;}
  function add(role,text){
    const div=document.createElement('div');div.className='text-sm';
    div.innerHTML = role==='user'
      ? '<div class="bg-indigo-600 text-white rounded-xl p-2">'+esc(text)+'</div>'
      : '<div class="bg-white rounded-xl border p-2">'+esc(text)+'</div>';
    chatEl.appendChild(div); window.scrollTo(0,document.body.scrollHeight);
    return div;
  }

  async function parseMaybeJson(res){
    const text = await res.text();
    try { return { data: JSON.parse(text), raw: text }; }
    catch { return { data: null, raw: text }; }
  }

  function showErrorFromPayload(payload, status){
    const e = payload?.error || {};
    const pieces = [];
    if (e.message) pieces.push(e.message);
    if (e.code) pieces.push('code: ' + e.code);
    if (e.provider) pieces.push('provider: ' + e.provider);
    if (e.endpoint) pieces.push('endpoint: ' + e.endpoint);
    if (e.requestId) pieces.push('requestId: ' + e.requestId);
    if (e.cid) pieces.push('cid: ' + e.cid);
    if (!pieces.length) pieces.push('HTTP ' + (status || ''));
    return 'Server error â€” ' + pieces.join(' Â· ');
  }

  function updateIdentityUI(user){
    if (user) {
      whoamiEl.textContent = 'Signed in as ' + (user.email || '');
      logoutBtn.classList.remove('hidden');
      loginBtn.classList.add('hidden');
      const roles=(user.app_metadata&&user.app_metadata.roles)||[];
      const link=document.getElementById('adminLink');
      if (link){ roles.includes('admin') ? link.classList.remove('hidden') : link.classList.add('hidden'); }
    } else {
      whoamiEl.textContent = 'Browsing as guest';
      logoutBtn.classList.add('hidden');
      loginBtn.classList.remove('hidden');
      const link=document.getElementById('adminLink');
      if (link) link.classList.add('hidden');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Initialize Identity without redirecting away from the page
    const initIdentity = () => {
      if (!window.netlifyIdentity) { setTimeout(initIdentity, 200); return; }
      window.netlifyIdentity.on('init', user => updateIdentityUI(user));
      window.netlifyIdentity.on('login', user => updateIdentityUI(user));
      window.netlifyIdentity.on('logout', () => updateIdentityUI(null));
      window.netlifyIdentity.init();
    };
    initIdentity();

    loginBtn.addEventListener('click', () => {
      if (window.netlifyIdentity) window.netlifyIdentity.open();
    });
    logoutBtn.addEventListener('click', () => {
      if (window.netlifyIdentity) window.netlifyIdentity.logout();
    });
  });

  async function send(){
    const q=inputEl.value.trim(); if(!q) return;
    add('user',q); inputEl.value='';
    const thinking = add('assistant','Thinkingâ€¦');
    sendBtn.disabled = true;

    try{
      // Build a small, capped context (best-effort search)
      let ctx = '';
      try{
        const sres = await fetch(SEARCH_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ q }) });
        if (sres.ok){
          const sj = await sres.json();
          ctx = (sj.results||[]).slice(0,5).map(r=>'â€¢ '+(r.title||'')+': '+(r.text||'').slice(0,800)).join('\n');
          if (ctx.length > 6000) ctx = ctx.slice(0,6000) + 'â€¦';
        }
      }catch(_){}

      // Chat call (body matches server)
      const res = await fetch(BACKEND_URL,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ q, context: ctx || 'No extra context' })
      });

      const { data, raw } = await parseMaybeJson(res);
      chatEl.removeChild(thinking);

      if (!res.ok || (data && (data.ok === false || data.error))){
        const msg = data ? showErrorFromPayload(data, res.status)
                         : `Server error â€” HTTP ${res.status} Â· ${raw?.slice(0,200)}`;
        add('assistant', msg);
        return;
      }

      const answer = (data && (data.answer || data.output_text)) || 'No response.';
      add('assistant', answer);

      const resources = (data && data.resources) || [];
      if (Array.isArray(resources) && resources.length){
        const div=document.createElement('div');
        div.className='text-xs text-gray-600 mt-1';
        div.innerHTML='<div class="font-semibold mt-2">ðŸ“š Further learning resources:</div>' +
          resources.map(r=>'<div><a href="'+esc(r.url)+'" target="_blank" class="text-indigo-600 underline">'+esc(r.label||r.title||r.url)+'</a></div>').join('');
        chatEl.appendChild(div);
      }

      // Fire-and-forget log
      try{ fetch(LOG_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question:q, answer:answer }) }); }catch(_){}
    }catch(e){
      try{ chatEl.removeChild(thinking); }catch(_){}
      add('assistant','There was an error â€” '+(e?.message || String(e)));
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener('click',send);
  inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
</script>
</body></html>
