<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quality Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Optional: set your backend URL here if front end is on a different host -->
  <!-- <meta name="quality-chat-backend" content="https://YOUR-BACKEND/chat"> -->
</head>
<body class="bg-gray-50 text-gray-900" style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;">
  <div class="min-h-screen flex flex-col">
    <header class="bg-white border-b sticky top-0 z-10">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-2xl bg-indigo-600 flex items-center justify-center shadow text-white font-bold">Q</div>
          <div>
            <h1 class="text-lg font-semibold leading-tight">Quality Chat</h1>
            <p class="text-xs text-gray-500 -mt-0.5">Ask anything about Quality & Compliance</p>
          </div>
        </div>
        <a href="#" id="clearBtn" class="text-xs text-gray-500 hover:text-gray-700">Clear chat</a>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-4xl mx-auto px-4 py-6">
        <section id="suggestions" class="grid gap-2 grid-cols-1 sm:grid-cols-2 mb-4">
          <button class="px-3 py-2 rounded-xl border bg-white text-left hover:bg-gray-50" data-suggest>
            How do 21 CFR Part 11 and EU Annex 11 differ?
          </button>
          <button class="px-3 py-2 rounded-xl border bg-white text-left hover:bg-gray-50" data-suggest>
            Draft a CAPA root cause statement for data entry errors.
          </button>
          <button class="px-3 py-2 rounded-xl border bg-white text-left hover:bg-gray-50" data-suggest>
            Explain risk-based validation for eClinical systems.
          </button>
          <button class="px-3 py-2 rounded-xl border bg-white text-left hover:bg-gray-50" data-suggest>
            Create a training outline for ICH E6(R3) principles.
          </button>
        </section>

        <section id="chat" class="space-y-4"></section>
      </div>
    </main>

    <footer class="sticky bottom-0 bg-white border-t">
      <div class="max-w-4xl mx-auto px-4 py-3">
        <div class="rounded-2xl border bg-white shadow-sm p-2">
          <textarea id="input" rows="2" placeholder="Ask a quality question… (Shift+Enter = newline)" class="w-full resize-none outline-none p-2 rounded-xl"></textarea>
          <div class="flex items-center justify-between px-1 pb-1">
            <small class="text-gray-500">Powered by OpenAI • Your key stays on the server</small>
            <button id="send" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 disabled:opacity-50">Send</button>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const META = document.querySelector('meta[name="quality-chat-backend"]');
    const BACKEND_URL = (META && META.content) || "/.netlify/functions/chat";
    const SEARCH_URL = "/.netlify/functions/search";

    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clearBtn');

    const sysPrompt = `You are Quality Chat, a helpful assistant for quality & compliance questions in life sciences. Be concise, cite authoritative standards by name (e.g., 21 CFR Part 11, EU GMP Annex 11, ICH E6(R3)) when relevant, and give actionable steps, examples, and cautions. If a question requires legal or regulatory interpretation, include a gentle disclaimer and refer users to the official text.

Few-shot examples (style & structure):
USER: Give a CAPA root cause statement for repeated data entry errors.
ASSISTANT:
Summary: Repeated data entry errors originate from inadequate user training on the eCRF, lack of double-data verification, and poorly configured field validations.
Actions: 1) Implement mandatory refresher training; 2) Enable field-level validation and required fields; 3) Add peer verification for critical fields; 4) Trend errors monthly.
References: 21 CFR Part 11 §11.10(k); ICH E6(R3) – Quality by Design, Data Integrity.

USER: Outline risk-based validation for an eClinical system upgrade.
ASSISTANT:
Summary: Apply a proportionate validation approach focused on high-risk functions (randomization, dosing, endpoint capture) and data integrity controls.
Actions: Develop/update URS; perform risk assessment; tailor test depth for GxP-impacting functions; qualify infrastructure; document traceability; run PQ in a representative environment.
References: EU GMP Annex 11 (Validation), GAMP 5, ICH E6(R3).
`;

    let history = [
      { role: 'system', content: sysPrompt },
      { role: 'assistant', content: "Hi! I'm Quality Chat. What quality or compliance question can I help with today?" }
    ];

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.innerText = text;
      return div.innerHTML;
    }

    function appendMessage(role, text) {
      const bubble = document.createElement('div');
      bubble.className = `flex gap-3 ${role==='user' ? 'justify-end' : ''}`;
      const isUser = role === 'user';
      bubble.innerHTML = `
        <div class="max-w-[85%] ${isUser ? 'bg-indigo-600 text-white' : 'bg-white'} rounded-2xl border ${isUser ? 'border-indigo-600' : 'border-gray-200'} p-3 shadow-sm">
          <div class="msg text-sm whitespace-pre-wrap">${escapeHtml(text)}</div>
        </div>`;
      chatEl.appendChild(bubble);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function send() {
      const content = inputEl.value.trim();
      if (!content) return;
      document.getElementById('suggestions')?.remove();
      appendMessage('user', content);
      inputEl.value = '';
      sendBtn.disabled = true;
      appendMessage('assistant', 'Thinking…');

      try {
        const sres = await fetch(SEARCH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: content })
        });
        let contextBlock = '';
        if (sres.ok) {
          const sj = await sres.json();
          const results = sj.results || [];
          if (results.length) {
            contextBlock = results.map(r => `• ${r.title}: ${r.text}`).join("\n");
          }
        }

        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role: 'system', content: sysPrompt },
              { role: 'system', content: contextBlock ? `Context (use for citations):\n${contextBlock}` : 'No extra context' },
              { role: 'user', content }
            ]
          })
        });

        const data = await res.json();
        chatEl.lastElementChild.remove();

        if (!res.ok || data.error) {
          if (data.detail && typeof data.detail === 'string' && data.detail.includes('insufficient_quota')) {
            appendMessage('assistant', 'Out of credits on the OpenAI API key. Please check billing on platform.openai.com.');
          } else {
            appendMessage('assistant', `Server error: ${data.error || res.status}\n${data.detail ? `Details: ${data.detail}` : ''}`);
          }
          return;
        }

        if (data.answer && data.answer.trim()) {
          appendMessage('assistant', data.answer);
          history.push({ role: 'user', content });
          history.push({ role: 'assistant', content: data.answer });
        } else {
          appendMessage('assistant', `No response from model.${data.debug ? `\nDebug: ${JSON.stringify(data.debug)}` : ''}`);
        }
      } catch (err) {
        chatEl.lastElementChild.remove();
        appendMessage('assistant', 'There was an error reaching the server. Please try again.');
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      chatEl.innerHTML = '';
      history = [ { role: 'system', content: sysPrompt } ];
      appendMessage('assistant', 'Chat cleared. How can I help?');
    });

    appendMessage('assistant', history[1].content);
    document.querySelectorAll('[data-suggest]').forEach(btn => {
      btn.addEventListener('click', () => { inputEl.value = btn.textContent.trim(); inputEl.focus(); });
    });
  </script>
</body>
</html>
